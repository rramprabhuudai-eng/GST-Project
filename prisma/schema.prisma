// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Contact {
  id                String   @id @default(cuid())
  name              String
  email             String?  @unique
  phone             String?  @unique
  whatsapp_number   String?
  whatsapp_consent  Boolean  @default(false)
  gstin             String?  @unique
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  deadlines        Deadline[]
  messageOutbox    MessageOutbox[]

  @@map("contacts")
}

model Deadline {
  id              String    @id @default(cuid())
  contact_id      String
  gstin           String
  return_type     String    // e.g., "GSTR-1", "GSTR-3B"
  period          String    // e.g., "2024-01"
  due_date        DateTime
  filed_at        DateTime?
  status          String    @default("pending") // pending, filed, missed
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  contact         Contact   @relation(fields: [contact_id], references: [id], onDelete: Cascade)
  reminderSchedule ReminderSchedule[]

  @@index([contact_id])
  @@index([due_date])
  @@index([status])
  @@map("deadlines")
}

model ReminderSchedule {
  id            String    @id @default(cuid())
  deadline_id   String
  template_id   String    // e.g., "gst_deadline_tminus3", "gst_deadline_tminus1", "gst_deadline_dueday"
  send_at       DateTime
  sent_at       DateTime?
  status        String    @default("pending") // pending, sent, skipped, failed
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  deadline      Deadline  @relation(fields: [deadline_id], references: [id], onDelete: Cascade)

  @@index([send_at])
  @@index([status])
  @@index([deadline_id])
  @@map("reminder_schedule")
}

model MessageOutbox {
  id              String    @id @default(cuid())
  contact_id      String
  template_id     String
  parameters      Json      // JSON object with template parameters
  phone_number    String
  scheduled_for   DateTime
  sent_at         DateTime?
  status          String    @default("pending") // pending, sent, failed
  message_id      String?   // BSP message ID after sending
  error_message   String?
  retry_count     Int       @default(0)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  contact         Contact   @relation(fields: [contact_id], references: [id], onDelete: Cascade)

  @@index([scheduled_for])
  @@index([status])
  @@index([contact_id])
  @@map("message_outbox")
}
